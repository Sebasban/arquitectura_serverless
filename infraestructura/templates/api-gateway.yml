AWSTemplateFormatVersion: '2010-09-09'
Description: HTTP API (API Gateway v2) integrado con una Lambda existente

Parameters:
  ProjectName:
    Type: String
    Default: events-app
  LambdaFunctionArn:
    Type: String

Resources:
  # HTTP API (API Gateway v2)
  HttpApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub ${ProjectName}-http-api-create-events
      ProtocolType: HTTP
      CorsConfiguration:
        AllowOrigins: ['*']
        AllowMethods: ['POST','PUT','DELETE','OPTIONS']
        AllowHeaders: ['content-type','authorization']

  # Integración Lambda
  ApiIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref HttpApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LambdaFunctionArn}/invocations
      PayloadFormatVersion: '2.0'

  # Rutas
  PostAggRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref HttpApi
      RouteKey: 'POST /agg'
      Target: !Sub integrations/${ApiIntegration}

  PutModifyRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref HttpApi
      RouteKey: 'PUT /modify'
      Target: !Sub integrations/${ApiIntegration}

  DeleteDeleteRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref HttpApi
      RouteKey: 'DELETE /delete'
      Target: !Sub integrations/${ApiIntegration}

  # Stage
  ApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref HttpApi
      StageName: v1
      AutoDeploy: true

  # Permiso para que API Gateway invoque la Lambda
  ApiInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref LambdaFunctionArn
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      # Permite invocaciones desde cualquier método/ruta del API y cualquier stage (por simplicidad)
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${HttpApi}/*/*/*

Outputs:
  ApiBaseUrl:
    Value: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/v1
    Description: URL base del API
  PostAggEndpoint:
    Value: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/v1/agg
    Description: Endpoint POST /agg
  PutModifyEndpoint:
    Value: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/v1/modify
    Description: Endpoint PUT /modify
  DeleteDeleteEndpoint:
    Value: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/v1/delete
    Description: Endpoint DELETE /delete
